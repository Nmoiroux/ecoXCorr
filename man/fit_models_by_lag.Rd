% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/funs.R
\name{fit_models_by_lag}
\alias{fit_models_by_lag}
\title{Fit regression models by lag window on aggregated meteorological predictors}
\usage{
fit_models_by_lag(
  data,
  response,
  predictors,
  random = "",
  family = "gaussian()",
  min_n = 10,
  track = F,
  ...
)
}
\arguments{
\item{data}{A data frame containing, at minimum, the columns
\code{lag_start}, \code{lag_end}, \code{date}, the response variable,
the predictor variable(s) and optional random-effect variables.}

\item{response}{Character string giving the name of the response variable.}

\item{predictors}{Character vector of predictor names. Currently, only
a single predictor is supported; providing more than one predictor
will result in an error.}

\item{random}{Optional character string specifying random-effects terms
to be added to the model formula (without a leading \code{+}), e.g.
\code{"(1 | site/year)"} or \code{"(1 | site) + (1 | year)"} (\code{?glmmTMB::glmmTMB}).
If empty (default), a fixed-effect model is fitted.}

\item{family}{Character string. The name of a family function
to be used in GLM or GLMM models. Default to "gaussian" (Linear model).
see \code{?stats::family} and \code{?glmmTMB::family_glmmTMB}}

\item{min_n}{Minimum number of observations required to fit a model.
(Currently not enforced; retained for future extensions.)}

\item{track}{If TRUE, lag window is printed in the console before model fitting.}

\item{...}{Additional arguments passed to the underlying modelling
function (\code{glm}, or \code{glmmTMB::glmmTMB}).}
}
\value{
A data frame with one row per lag window, containing:
  \describe{
    \item{lag_start}{Start lag index of the aggregation window.}
    \item{lag_end}{End lag index of the aggregation window.}
    \item{predictor}{Name of the predictor variable.}
    \item{p_value}{P-value associated with the predictor effect.}
    \item{r2}{Coefficient of determination (marginal \eqn{R^2} for mixed models).}
    \item{betas}{Estimated beta parameter of the linear predictor.}
    \item{sign}{Sign of the estimated predictor effect (-1 or +1).}
    \item{d_aic}{AIC reduction compared to the null model.}
    \item{n}{Number of observations used to fit the model.}
  }
}
\description{
This function fits a regression model separately for each lag window
defined by the \code{lag_start} and \code{lag_end} columns of the input
data frame. For each lag window, the model is fitted using
observations corresponding to different reference dates (\code{date}),
and summary statistics (p-value, betas, sign of effect, \eqn{R^2}, AIC reduction, sample size) are returned
for the specified predictor.
}
\details{
Both fixed-effect and mixed-effect models are supported.
The modelling function used depends on the \code{random} arguments:
\itemize{
  \item \code{random = ""}:  \code{\link[stats]{glm}}
  \item \code{random != ""}: \code{\link[glmmTMB]{glmmTMB}}
}

For mixed-effects models, marginal \eqn{R^2} (Nakagawa) is returned. For fixed-effects
models, classical \eqn{R^2} is used.


For each unique combination of \code{lag_start} and \code{lag_end}, the
function:
\enumerate{
  \item Subsets the data to the corresponding lag window,
  \item Removes rows with missing values in the response or predictor,
  \item Fits the specified model,
  \item Extracts beta parameter of the linear predictor,
  \item Extracts the p-value of the predictor effect,
  \item Computes AIC for the specified and null models,
  \item Computes the model \eqn{R^2} (marginal \eqn{R^2} for mixed models),
  \item Records the sign of the estimated effect and the sample size.
}

The returned table is suitable for lag-window screening, heatmap
visualisation, or sensitivity analyses in epidemiological or ecological
studies.
}
\seealso{
\code{\link[glmmTMB]{glmmTMB}},
\code{\link[performance]{r2}},
\code{\link[performance]{r2_nakagawa}}
}

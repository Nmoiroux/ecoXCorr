% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/funs.R
\name{fit_models_by_lag}
\alias{fit_models_by_lag}
\title{Fit regression models by lag window on aggregated meteorological predictors}
\usage{
fit_models_by_lag(
  data,
  response,
  predictors,
  covariates = character(0),
  random = character(0),
  family = "gaussian",
  min_n = 10,
  track = F,
  ...
)
}
\arguments{
\item{data}{A data frame containing, at minimum, the columns
\code{lag_start}, \code{lag_end}, \code{date}, the response variable, response \code{ID},
the predictor variable(s) and optional covariates and random-effect variables.}

\item{response}{Character string giving the name of the response variable.}

\item{predictors}{Character vector of predictor names. Currently, only
a single predictor is supported; providing more than one predictor
will result in an error.}

\item{covariates}{Character vector of predictor names to be included in the fixed part of the model to control for their effect.}

\item{random}{Optional character string specifying random-effects terms or
covariance structure to be added to the model formula (without a leading \code{+}), e.g.
\code{"(1 | site/year)"}, \code{"(1 | site) + (1 | year)"} or \code{"ar1(times + 0 | group)"} (\code{?glmmTMB::glmmTMB}).
If empty (default), a fixed-effect model is fitted.}

\item{family}{Character string. The name of a family function
to be used in GLM or GLMM models. Default to "gaussian" (Linear model).
see \code{?stats::family} and \code{?glmmTMB::family_glmmTMB} for valid family functions.}

\item{min_n}{Minimum number of observations required to fit a model.
(Currently not enforced; retained for future extensions.)}

\item{track}{If TRUE, lag window is printed in the console before model fitting.}

\item{...}{Additional arguments passed to the underlying modelling
function (\code{glm}, or \code{glmmTMB::glmmTMB}).}
}
\value{
A data frame with one row per lag window, containing:
  \describe{
    \item{lag_start}{Start lag index of the aggregation window.}
    \item{lag_end}{End lag index of the aggregation window.}
    \item{response}{Name of the response variable.}
    \item{predictor}{Name of the predictor variable.}
    \item{R2...}{Model's coefficient of determination (marginal \eqn{R^2} for mixed models).}
    \item{betas}{Estimated beta parameter of the linear predictor.}
    \item{sign}{Sign of the estimated predictor effect (-1 or +1).}
    \item{d_aic}{AIC reduction compared to the null model.}
    \item{n}{Number of observations used to fit the model.}
    \item{p_value}{P-value associated with the predictor effect.}
    \item{weight}{Akaike weight.}
    \item{p_adj}{P-value of the estimated predictor effect, adjusted for multiple testing (false discovery rate method.}
  }
}
\description{
This function fits a regression model separately for each lag window
defined by the \code{lag_start} and \code{lag_end} columns of the input
data frame. For each lag window, the model is fitted using
observations corresponding to different reference dates (\code{date}),
and summary statistics (betas, sign of effect, \eqn{R^2}, delta AIC, Akaike weight, sample size, p-value, p-value adjusted for multiple testing) are returned
for the specified predictor.
}
\details{
Both fixed-effect and mixed-effect models are supported.

The modelling function used depends on the \code{random} and \code{family} arguments:
\itemize{
  \item \code{random} is not specified (default):  \code{\link[stats]{glm}}
  \item \code{random} is note an empty string OR \code{family} is a valid glmmTMB family: \code{\link[glmmTMB]{glmmTMB}}
}

For mixed-effects models, marginal \eqn{R^2} (Nakagawa) is returned. For fixed-effects
models, appropriate \eqn{R^2} is used (see \code{?performance::r2()}).
Depending on model specification (depending on \code{random} and/or \code{family}), \eqn{R^2} for \code{\link[glmmTMB]{glmmTMB}} models may not be computed: the returned error or warning is printed in the console.


For each unique combination of \code{lag_start} and \code{lag_end}, the
function:
\enumerate{
  \item Subsets the data to the corresponding lag window,
  \item Removes rows with missing values in the response or predictor,
  \item Fits the specified model,
  \item Extracts beta parameter of the linear predictor,
  \item Extracts the p-value of the predictor effect,
  \item Computes AIC for the specified and null models (i.e. excluding `predictors` in the fixed part),
  \item Computes the appropriate model\eqn{R^2} (marginal Nakagawa \eqn{R^2} for mixed models),
  \item Records the sign of the estimated effect and the sample size,
  \item Computes delta-AIC and Akaike weight of each model \insertCite{vandepolIdentifyingBestClimatic2016}{ecoXCorr},
  \item Computes adjusted p-value using the False Discovery Rate method \insertCite{benjaminiControlFalseDiscovery2001}{ecoXCorr}
}

The returned table is suitable for lag-window screening, heatmap
visualisation, or sensitivity analyses in epidemiological or ecological
studies.
}
\examples{
sampling_dates <- unique(albopictusMPL2023$date)

met_agg <- aggregate_lagged_intervals(
data       = meteoMPL2023,
date_col   = "date",
value_cols = c("rain_sum", "temp_mean"),
ref_date   = sampling_dates,
interval   = 7,
max_lag    = 8
)

albo_lag <- merge(met_agg, albopictusMPL2023, by = "date", all = TRUE)

res_glm <- fit_models_by_lag(
data       = albo_lag,
response   = "individualCount",
predictors = "rain_sum_sum",
random     = "",
family     = "poisson"
)

head(res_glm)

}
\references{
\insertAllCited{}
}
\seealso{
\code{\link[glmmTMB]{glmmTMB}},
\code{\link[performance]{r2}},
\code{\link[performance]{r2_nakagawa}}
}
